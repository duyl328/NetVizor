<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ç»Ÿä¸€è™šæ‹Ÿæ»šåŠ¨åˆ—è¡¨</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			background-color: #f5f5f7;
			color: #333;
		}

		.container {
			max-width: 600px;
			margin: 0 auto;
			background-color: #fff;
			min-height: 100vh;
			box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
		}

		.page-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 20px;
			text-align: center;
			position: relative;
			overflow: hidden;
		}

		.page-header h1 {
			font-size: 24px;
			font-weight: 600;
			position: relative;
			z-index: 1;
		}

		.page-header::before {
			content: '';
			position: absolute;
			top: -50%;
			right: -50%;
			width: 200%;
			height: 200%;
			background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
			animation: shimmer 3s infinite;
		}

		@keyframes shimmer {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.virtual-list-container {
			position: relative;
			width: 100%;
		}

		.virtual-list-wrapper {
			position: relative;
			width: 100%;
		}

		.virtual-list-spacer {
			width: 100%;
			pointer-events: none;
		}

		.virtual-list-viewport {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
		}

		.virtual-list-item {
			position: absolute;
			width: 100%;
			display: flex;
			align-items: center;
			overflow: hidden;
			transition: background-color 0.2s ease, padding-left 0.2s ease;
		}

		/* è¡¨å¤´æ ·å¼ */
		.virtual-list-item.header {
			height: 60px;
			background: rgba(248, 249, 250, 0.95);
			padding: 15px 20px;
			font-weight: 600;
			font-size: 16px;
			color: #495057;
			border-bottom: 2px solid #e9ecef;
			backdrop-filter: blur(10px);
			cursor: pointer;
			user-select: none;
			justify-content: space-between;
			z-index: 100;
		}

		/* å¸é¡¶è¡¨å¤´ */
		.sticky-header {
			position: fixed;
			top: 0;
			left: 50%;
			transform: translateX(-50%);
			width: 600px;
			max-width: 100vw;
			z-index: 1000;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			transition: all 0.3s ease;
		}

		.sticky-header-placeholder {
			height: 60px;
			background: transparent;
			pointer-events: none;
		}

		.virtual-list-item.header:hover {
			background: rgba(248, 249, 250, 1);
			transform: translateY(-1px);
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}

		.header-content {
			display: flex;
			align-items: center;
		}

		.header-content::before {
			content: 'ğŸ“‹';
			margin-right: 8px;
		}

		.header-info {
			font-size: 12px;
			opacity: 0.7;
			margin-left: 10px;
		}

		.header-arrow {
			font-size: 12px;
			transition: transform 0.3s ease;
		}

		.header-arrow.collapsed {
			transform: rotate(-90deg);
		}

		/* åˆ—è¡¨é¡¹æ ·å¼ */
		.virtual-list-item.item {
			height: 60px;
			padding: 15px 20px;
			border-bottom: 1px solid #f1f3f5;
			background: white;
		}

		.virtual-list-item.item::before {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			height: 100%;
			width: 3px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			transform: translateX(-100%);
			transition: transform 0.3s ease;
		}

		.virtual-list-item.item:hover {
			background-color: #f8f9fa;
			padding-left: 30px;
		}

		.virtual-list-item.item:hover::before {
			transform: translateX(0);
		}

		.item-number {
			display: inline-block;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			width: 28px;
			height: 28px;
			text-align: center;
			line-height: 28px;
			border-radius: 50%;
			font-size: 12px;
			font-weight: 600;
			margin-right: 12px;
			flex-shrink: 0;
		}

		.item-content {
			flex: 1;
			font-size: 14px;
		}

		/* ä¸åŒåˆ†ç±»çš„é¢œè‰²ä¸»é¢˜ */
		.virtual-list-item.header.category-1 {
			background: rgba(255, 243, 224, 0.95);
			color: #ff6b6b;
		}

		.virtual-list-item.header.category-1 .header-content::before {
			content: 'ğŸ”';
		}

		.virtual-list-item.header.category-2 {
			background: rgba(224, 255, 224, 0.95);
			color: #51cf66;
		}

		.virtual-list-item.header.category-2 .header-content::before {
			content: 'ğŸ¥—';
		}

		.virtual-list-item.header.category-3 {
			background: rgba(224, 240, 255, 0.95);
			color: #339af0;
		}

		.virtual-list-item.header.category-3 .header-content::before {
			content: 'ğŸ°';
		}

		.virtual-list-item.header.category-4 {
			background: rgba(255, 224, 255, 0.95);
			color: #ae3ec9;
		}

		.virtual-list-item.header.category-4 .header-content::before {
			content: 'ğŸ¥¤';
		}

		/* æ»šåŠ¨æç¤º */
		.scroll-indicator {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 10px 15px;
			border-radius: 20px;
			font-size: 12px;
			opacity: 0;
			transition: opacity 0.3s ease;
			pointer-events: none;
		}

		.scroll-indicator.show {
			opacity: 1;
		}

		.performance-info {
			position: fixed;
			top: 20px;
			right: 20px;
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 8px 12px;
			border-radius: 15px;
			font-size: 11px;
			font-family: monospace;
			z-index: 1000;
			max-width: 300px;
			white-space: pre-line;
		}

		/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
		@media (max-width: 768px) {
			.container {
				box-shadow: none;
			}

			.page-header h1 {
				font-size: 20px;
			}

			.virtual-list-item.header {
				padding: 12px 15px;
				font-size: 15px;
			}

			.virtual-list-item.item {
				padding: 12px 15px;
				height: 55px;
			}

			.performance-info {
				display: none;
			}

			.sticky-header {
				width: 100vw;
				left: 0;
				transform: translateX(0);
			}

			.sticky-header.header {
				padding: 12px 15px;
				font-size: 15px;
			}
		}
	</style>
</head>
<body>
<div class="performance-info" id="performanceInfo">
	æ¸²æŸ“: 0 / 0 é¡¹ç›®
</div>

<div class="container">
	<div class="page-header">
		<h1>ç»Ÿä¸€è™šæ‹Ÿæ»šåŠ¨åˆ—è¡¨æ¼”ç¤º</h1>
		<p style="font-size: 14px; margin-top: 10px; opacity: 0.9;">è¡¨å¤´å’Œåˆ—è¡¨é¡¹ç»Ÿä¸€ç®¡ç†ï¼Œæ”¯æŒå¤§é‡æ•°æ®</p>
	</div>

	<div id="listContainer"></div>
</div>

<div class="scroll-indicator" id="scrollIndicator">ç»§ç»­æ»šåŠ¨æŸ¥çœ‹æ›´å¤š</div>

<script>
	// é˜²æŠ–å‡½æ•°
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}

	// ä¼˜åŒ–çš„èŠ‚æµå‡½æ•°
	function throttle(func, delay) {
		let timeoutId;
		let lastExecTime = 0;

		return function (...args) {
			const currentTime = Date.now();

			if (currentTime - lastExecTime > delay) {
				func.apply(this, args);
				lastExecTime = currentTime;
			} else {
				clearTimeout(timeoutId);
				timeoutId = setTimeout(() => {
					func.apply(this, args);
					lastExecTime = Date.now();
				}, delay - (currentTime - lastExecTime));
			}
		};
	}

	class UnifiedVirtualList {
		constructor(container, options = {}) {
			this.container = container;
			this.itemHeight = options.itemHeight || 60;
			this.headerHeight = options.headerHeight || 60;
			this.allItems = []; // åŒ…å«è¡¨å¤´å’Œåˆ—è¡¨é¡¹çš„ç»Ÿä¸€æ•°ç»„
			this.visibleItems = []; // å½“å‰å®é™…æ˜¾ç¤ºçš„é¡¹ç›®
			this.collapsedSections = new Set(); // æŠ˜å çš„åˆ†åŒº

			this.startIndex = 0;
			this.endIndex = 0;
			this.bufferSize = 10;

			// ç¨³å®šæ€§ä¼˜åŒ–å‚æ•°
			this.lastScrollTop = 0;
			this.scrollDirection = 'down';
			this.lastRenderTime = 0;
			this.minRenderInterval = 32; // æœ€å°æ¸²æŸ“é—´éš”

			this.init();
		}

		init() {
			// åˆ›å»ºè™šæ‹Ÿåˆ—è¡¨å®¹å™¨
			this.listContainer = document.createElement('div');
			this.listContainer.className = 'virtual-list-container';

			// åˆ›å»ºåŒ…è£…å™¨
			this.wrapper = document.createElement('div');
			this.wrapper.className = 'virtual-list-wrapper';

			// åˆ›å»ºå ä½ç©ºé—´å…ƒç´ ï¼ˆç»´æŒæ€»é«˜åº¦ï¼‰
			this.spacer = document.createElement('div');
			this.spacer.className = 'virtual-list-spacer';

			// åˆ›å»ºè§†å£
			this.viewport = document.createElement('div');
			this.viewport.className = 'virtual-list-viewport';

			// åˆ›å»ºå¸é¡¶è¡¨å¤´å®¹å™¨
			this.stickyHeader = null;
			this.stickyHeaderPlaceholder = null;

			this.wrapper.appendChild(this.spacer);
			this.wrapper.appendChild(this.viewport);
			this.listContainer.appendChild(this.wrapper);
			this.container.appendChild(this.listContainer);
		}

		// è®¾ç½®æ•°æ®
		setData(datasets) {
			this.allItems = [];
			this.visibleItems = [];

			datasets.forEach((dataset, sectionIndex) => {
				// æ·»åŠ è¡¨å¤´
				const header = {
					type: 'header',
					title: dataset.title,
					count: dataset.data.length,
					sectionIndex: sectionIndex,
					categoryClass: `category-${sectionIndex % 4}`,
					collapsed: dataset.collapsed || false
				};

				this.allItems.push(header);

				// å¦‚æœè¯¥åˆ†åŒºæŠ˜å ï¼Œè®°å½•åˆ°æŠ˜å é›†åˆä¸­
				if (header.collapsed) {
					this.collapsedSections.add(sectionIndex);
				}

				// æ·»åŠ åˆ—è¡¨é¡¹
				dataset.data.forEach((item, itemIndex) => {
					this.allItems.push({
						type: 'item',
						content: item,
						sectionIndex: sectionIndex,
						itemIndex: itemIndex,
						globalIndex: itemIndex + 1
					});
				});
			});

			this.updateVisibleItems();
			this.updateSpacerHeight();
		}

		// æ›´æ–°å¯è§é¡¹ç›®åˆ—è¡¨
		updateVisibleItems() {
			this.visibleItems = this.allItems.filter(item => {
				if (item.type === 'header') {
					return true; // è¡¨å¤´æ€»æ˜¯å¯è§
				}
				// åªæœ‰å½“åˆ†åŒºæœªæŠ˜å æ—¶ï¼Œåˆ—è¡¨é¡¹æ‰å¯è§
				return !this.collapsedSections.has(item.sectionIndex);
			});
		}

		// æ›´æ–°ç©ºé—´å ä½é«˜åº¦
		updateSpacerHeight() {
			const totalHeight = this.visibleItems.length * this.itemHeight;
			this.spacer.style.height = `${totalHeight}px`;
		}

		// è°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢æŠ˜å åå†…å®¹åŒºåŸŸè¿‡çŸ­
		adjustScrollPosition() {
			const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
			const containerTop = this.getAbsoluteOffset();
			const containerHeight = this.visibleItems.length * this.itemHeight;
			const windowHeight = window.innerHeight;

			// å¦‚æœå†…å®¹å¾ˆå°‘ï¼ˆæ¯”å¦‚åªæœ‰è¡¨å¤´ï¼‰ï¼Œç›´æ¥æ»šåŠ¨åˆ°å®¹å™¨é¡¶éƒ¨
			if (this.visibleItems.length <= 10) {
				setTimeout(() => {
					window.scrollTo({
						top: containerTop,
						behavior: 'smooth'
					});
				}, 100);
				return;
			}

			// è®¡ç®—æœ€å¤§æ»šåŠ¨ä½ç½®
			const maxScrollTop = containerTop + containerHeight - windowHeight;

			// å¦‚æœå½“å‰æ»šåŠ¨ä½ç½®è¶…å‡ºäº†å†…å®¹åŒºåŸŸï¼Œè‡ªåŠ¨è°ƒæ•´åˆ°åˆé€‚ä½ç½®
			if (scrollTop > maxScrollTop && maxScrollTop > containerTop) {
				setTimeout(() => {
					window.scrollTo({
						top: Math.max(containerTop, maxScrollTop),
						behavior: 'smooth'
					});
				}, 100);
			}
		}

		// åˆ‡æ¢åˆ†åŒºæŠ˜å çŠ¶æ€
		toggleSection(sectionIndex) {
			if (this.collapsedSections.has(sectionIndex)) {
				this.collapsedSections.delete(sectionIndex);
			} else {
				this.collapsedSections.add(sectionIndex);
			}

			this.updateVisibleItems();
			this.updateSpacerHeight();
			this.adjustScrollPosition();
			this.forceRefresh();
		}

		// è·å–ç»å¯¹ä½ç½®
		getAbsoluteOffset() {
			const rect = this.wrapper.getBoundingClientRect();
			const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
			return rect.top + scrollTop;
		}

		getVisibleRange() {
			// å¦‚æœæ²¡æœ‰å¯è§é¡¹ç›®ï¼Œç›´æ¥è¿”å›ç©ºèŒƒå›´
			if (this.visibleItems.length === 0) {
				return { start: 0, end: 0 };
			}

			// è·å–å½“å‰æ»šåŠ¨ä½ç½®
			const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
			const windowHeight = window.innerHeight;

			// æ£€æµ‹æ»šåŠ¨æ–¹å‘
			this.scrollDirection = scrollTop > this.lastScrollTop ? 'down' : 'up';
			this.lastScrollTop = scrollTop;

			// è·å–å®¹å™¨çš„ç»å¯¹ä½ç½®
			const containerTop = this.getAbsoluteOffset();
			const containerHeight = this.visibleItems.length * this.itemHeight;

			// ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœå®¹å™¨å¾ˆå°ï¼ˆæ¯”å¦‚åªæœ‰è¡¨å¤´ï¼‰ï¼Œå¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
			if (this.visibleItems.length <= 10) {
				return { start: 0, end: this.visibleItems.length };
			}

			// è®¡ç®—å¯è§åŒºåŸŸ
			const viewportTop = scrollTop;
			const viewportBottom = scrollTop + windowHeight;

			// è®¡ç®—åˆ—è¡¨åŒºåŸŸ
			const listTop = containerTop;
			const listBottom = containerTop + containerHeight;

			// æ£€æŸ¥æ˜¯å¦æœ‰äº¤é›† - æ”¾å®½æ¡ä»¶
			if (listBottom < viewportTop - windowHeight || listTop > viewportBottom + windowHeight) {
				// å¦‚æœå®Œå…¨æ²¡æœ‰äº¤é›†ä¸”è·ç¦»å¾ˆè¿œï¼Œæ˜¾ç¤ºå¼€å¤´éƒ¨åˆ†
				return { start: 0, end: Math.min(10, this.visibleItems.length) };
			}

			// è®¡ç®—å¯è§èŒƒå›´
			const visibleStartInList = Math.max(0, viewportTop - listTop);
			const visibleEndInList = Math.min(containerHeight, viewportBottom - listTop);

			// è®¡ç®—é¡¹ç›®ç´¢å¼•
			let startIndex = Math.floor(visibleStartInList / this.itemHeight);
			let endIndex = Math.ceil(visibleEndInList / this.itemHeight);

			// ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
			startIndex = Math.max(0, Math.min(startIndex, this.visibleItems.length - 1));
			endIndex = Math.max(startIndex + 1, Math.min(endIndex, this.visibleItems.length));

			// åŠ¨æ€è°ƒæ•´ç¼“å†²åŒºå¤§å°
			const dynamicBuffer = this.scrollDirection === 'down'
					? { top: Math.floor(this.bufferSize * 0.3), bottom: this.bufferSize }
					: { top: this.bufferSize, bottom: Math.floor(this.bufferSize * 0.3) };

			// æ·»åŠ ç¼“å†²åŒº
			const bufferedStart = Math.max(0, startIndex - dynamicBuffer.top);
			const bufferedEnd = Math.min(this.visibleItems.length, endIndex + dynamicBuffer.bottom);

			// æœ€ç»ˆéªŒè¯ï¼šç¡®ä¿èŒƒå›´æœ‰æ•ˆä¸”ä¸ä¸ºç©º
			if (bufferedStart >= bufferedEnd || bufferedStart >= this.visibleItems.length) {
				// å¦‚æœè®¡ç®—å‡ºçš„èŒƒå›´æ— æ•ˆï¼Œè¿”å›å‰å‡ ä¸ªé¡¹ç›®
				return {
					start: 0,
					end: Math.min(10, this.visibleItems.length)
				};
			}

			// ç¡®ä¿è‡³å°‘æ¸²æŸ“ä¸€ä¸ªé¡¹ç›®
			if (bufferedEnd - bufferedStart === 0) {
				bufferedEnd = Math.min(bufferedStart + 1, this.visibleItems.length);
			}

			return {
				start: bufferedStart,
				end: bufferedEnd
			};
		}

		shouldUpdate(newStart, newEnd) {
			// æ—¶é—´é™æµ
			const now = Date.now();
			if (now - this.lastRenderTime < this.minRenderInterval) {
				return false;
			}

			// å¦‚æœèŒƒå›´å®Œå…¨ç›¸åŒï¼Œä¸æ›´æ–°
			if (newStart === this.startIndex && newEnd === this.endIndex) {
				return false;
			}

			// å¦‚æœå†…å®¹å¾ˆå°‘ï¼Œæ€»æ˜¯æ›´æ–°ä»¥ç¡®ä¿æ˜¾ç¤º
			if (this.visibleItems.length <= 10) {
				return true;
			}

			// è®¡ç®—é‡å åŒºåŸŸ
			const overlapStart = Math.max(this.startIndex, newStart);
			const overlapEnd = Math.min(this.endIndex, newEnd);
			const overlapSize = Math.max(0, overlapEnd - overlapStart);
			const currentSize = this.endIndex - this.startIndex;

			// å¦‚æœé‡å åŒºåŸŸå å½“å‰æ˜¾ç¤ºåŒºåŸŸçš„å¤§éƒ¨åˆ†ï¼Œä¸”å˜åŒ–ä¸å¤§ï¼Œè·³è¿‡æ›´æ–°
			if (currentSize > 0 && overlapSize / currentSize > 0.7) {
				const startDiff = Math.abs(newStart - this.startIndex);
				const endDiff = Math.abs(newEnd - this.endIndex);

				// å¦‚æœå˜åŒ–å¾ˆå°ï¼Œè·³è¿‡
				if (startDiff <= 2 && endDiff <= 2) {
					return false;
				}
			}

			return true;
		}

		render() {
			const { start, end } = this.getVisibleRange();

			// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
			if (!this.shouldUpdate(start, end)) {
				this.updateStickyHeader();
				return;
			}

			console.log(`æ¸²æŸ“èŒƒå›´: ${start} - ${end} (ä¹‹å‰: ${this.startIndex} - ${this.endIndex}) æ€»é¡¹ç›®: ${this.visibleItems.length}`);

			this.startIndex = start;
			this.endIndex = end;
			this.lastRenderTime = Date.now();

			// æ¸…é™¤ç°æœ‰é¡¹ç›®
			this.viewport.innerHTML = '';

			// å¦‚æœæ²¡æœ‰å¯è§é¡¹ç›®ï¼Œç›´æ¥è¿”å›
			if (start >= end || this.visibleItems.length === 0) {
				this.updateStickyHeader();
				return;
			}

			// åˆ›å»ºæ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
			const fragment = document.createDocumentFragment();

			// æ¸²æŸ“å¯è§é¡¹ç›®
			for (let i = start; i < end && i < this.visibleItems.length; i++) {
				const itemData = this.visibleItems[i];
				const item = this.createItem(itemData, i);
				item.style.transform = `translateY(${i * this.itemHeight}px)`;
				item.dataset.visibleIndex = i;
				fragment.appendChild(item);
			}

			this.viewport.appendChild(fragment);

			// æ›´æ–°å¸é¡¶è¡¨å¤´
			this.updateStickyHeader();
		}

		createItem(data, index) {
			const item = document.createElement('div');
			item.className = `virtual-list-item ${data.type}`;

			if (data.type === 'header') {
				// åˆ›å»ºè¡¨å¤´
				item.classList.add(data.categoryClass);
				const isCollapsed = this.collapsedSections.has(data.sectionIndex);

				item.innerHTML = `
					<div class="header-content">
						<span>${data.title}</span>
						<span class="header-info">${data.count} é¡¹</span>
					</div>
					<span class="header-arrow ${isCollapsed ? 'collapsed' : ''}">â–¼</span>
				`;

				// ç»‘å®šç‚¹å‡»äº‹ä»¶
				item.addEventListener('click', () => {
					this.toggleSection(data.sectionIndex);

					// æ·»åŠ ç‚¹å‡»åŠ¨ç”»
					item.style.transform = `translateY(${index * this.itemHeight}px) scale(0.98)`;
					setTimeout(() => {
						item.style.transform = `translateY(${index * this.itemHeight}px)`;
					}, 200);
				});
			} else {
				// åˆ›å»ºåˆ—è¡¨é¡¹
				item.innerHTML = `
					<span class="item-number">${data.globalIndex}</span>
					<span class="item-content">${data.content}</span>
				`;

				// æ·»åŠ ç‚¹å‡»æ•ˆæœ
				item.addEventListener('click', () => {
					const scale = item.style.transform.includes('scale') ? '' : ' scale(0.98)';
					item.style.transform = `translateY(${index * this.itemHeight}px)${scale}`;
					if (scale) {
						setTimeout(() => {
							item.style.transform = `translateY(${index * this.itemHeight}px)`;
						}, 200);
					}
				});
			}

			return item;
		}

		updateOnScroll() {
			this.render();
		}

		// æ›´æ–°å¸é¡¶è¡¨å¤´
		updateStickyHeader() {
			const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
			const containerTop = this.getAbsoluteOffset();

			// æ‰¾åˆ°å½“å‰åº”è¯¥å¸é¡¶çš„è¡¨å¤´
			let currentStickyHeader = null;
			let currentStickyIndex = -1;

			for (let i = 0; i < this.visibleItems.length; i++) {
				const item = this.visibleItems[i];
				if (item.type === 'header') {
					const headerTop = containerTop + i * this.itemHeight;
					const headerBottom = headerTop + this.itemHeight;

					if (headerTop <= scrollTop) {
						// è¿™ä¸ªè¡¨å¤´å·²ç»æ»šåŠ¨åˆ°é¡¶éƒ¨ä¸Šæ–¹æˆ–åˆšå¥½åœ¨é¡¶éƒ¨
						currentStickyHeader = item;
						currentStickyIndex = i;
					} else {
						// è¿™ä¸ªè¡¨å¤´è¿˜åœ¨ä¸‹æ–¹ï¼Œåœæ­¢æ£€æŸ¥
						break;
					}
				}
			}

			// æ£€æŸ¥ä¸‹ä¸€ä¸ªè¡¨å¤´æ˜¯å¦å³å°†æ¨èµ°å½“å‰å¸é¡¶è¡¨å¤´
			let nextHeaderIndex = -1;
			if (currentStickyIndex >= 0) {
				for (let i = currentStickyIndex + 1; i < this.visibleItems.length; i++) {
					if (this.visibleItems[i].type === 'header') {
						nextHeaderIndex = i;
						break;
					}
				}
			}

			if (currentStickyHeader) {
				this.showStickyHeader(currentStickyHeader, nextHeaderIndex, containerTop, scrollTop);
			} else {
				this.hideStickyHeader();
			}
		}

		// æ˜¾ç¤ºå¸é¡¶è¡¨å¤´
		showStickyHeader(headerData, nextHeaderIndex, containerTop, scrollTop) {
			if (!this.stickyHeader) {
				this.stickyHeader = document.createElement('div');
				this.stickyHeader.className = 'virtual-list-item header sticky-header';
				document.body.appendChild(this.stickyHeader);
			}

			// æ›´æ–°å¸é¡¶è¡¨å¤´å†…å®¹
			this.stickyHeader.className = `virtual-list-item header sticky-header ${headerData.categoryClass}`;
			const isCollapsed = this.collapsedSections.has(headerData.sectionIndex);

			this.stickyHeader.innerHTML = `
				<div class="header-content">
					<span>${headerData.title}</span>
					<span class="header-info">${headerData.count} é¡¹</span>
				</div>
				<span class="header-arrow ${isCollapsed ? 'collapsed' : ''}">â–¼</span>
			`;

			// é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
			this.stickyHeader.onclick = () => {
				this.toggleSection(headerData.sectionIndex);

				// æ·»åŠ ç‚¹å‡»åŠ¨ç”»
				this.stickyHeader.style.transform = 'translateX(-50%) scale(0.98)';
				setTimeout(() => {
					this.stickyHeader.style.transform = 'translateX(-50%)';
				}, 200);
			};

			// è®¡ç®—ä½ç½®ï¼Œå¤„ç†ä¸‹ä¸€ä¸ªè¡¨å¤´æ¨èµ°çš„æ•ˆæœ
			let translateY = 0;
			if (nextHeaderIndex >= 0) {
				const nextHeaderTop = containerTop + nextHeaderIndex * this.itemHeight;
				const pushDistance = nextHeaderTop - scrollTop;
				if (pushDistance < this.itemHeight) {
					translateY = pushDistance - this.itemHeight;
				}
			}

			this.stickyHeader.style.transform = `translateX(-50%) translateY(${translateY}px)`;
			this.stickyHeader.style.display = 'flex';
		}

		// éšè—å¸é¡¶è¡¨å¤´
		hideStickyHeader() {
			if (this.stickyHeader) {
				this.stickyHeader.style.display = 'none';
			}
		}

		forceRefresh() {
			this.startIndex = -1;
			this.endIndex = -1;
			this.lastRenderTime = 0;
			this.render();
		}

		// æ¸…ç†èµ„æº
		destroy() {
			if (this.stickyHeader) {
				document.body.removeChild(this.stickyHeader);
				this.stickyHeader = null;
			}
		}
	}

	// ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®
	function generateLargeDataset(prefix, count) {
		const items = [];
		const foods = [
			'å®«ä¿é¸¡ä¸', 'éº»å©†è±†è…', 'çº¢çƒ§è‚‰', 'é±¼é¦™è‚‰ä¸', 'é’æ¤’è‚‰ä¸', 'ç³–é†‹é‡Œè„Š',
			'å›é”…è‚‰', 'è›‹ç‚’é¥­', 'æ‰¬å·ç‚’é¥­', 'ç‰›è‚‰é¢', 'å…°å·æ‹‰é¢', 'ç‚¸é…±é¢',
			'æ‹…æ‹…é¢', 'çƒ­å¹²é¢', 'é‡åº†å°é¢', 'å°ç¬¼åŒ…', 'ç…é¥º', 'è’¸é¥º',
			'åŒ…å­', 'é¦’å¤´', 'èŠ±å·', 'çƒ§é¥¼', 'æ²¹æ¡', 'è±†æµ†', 'èƒ¡è¾£æ±¤', 'ç…è›‹',
			'åŸ¹æ ¹', 'é¦™è‚ ', 'åå¸', 'ä¸‰æ˜æ²»', 'æ±‰å ¡', 'æŠ«è¨', 'æ„é¢', 'æ‹‰é¢'
		];

		for (let i = 0; i < count; i++) {
			const food = foods[i % foods.length];
			const variant = Math.floor(i / foods.length) + 1;
			const rating = 'â˜…'.repeat(Math.floor(Math.random() * 5) + 1);
			items.push(`${prefix}${food}${variant > 1 ? ` (${variant})` : ''} ${rating}`);
		}

		return items;
	}

	// åˆ›å»ºæ•°æ®é›†
	const datasets = [
		{
			title: 'æ—©é¤æ¨è',
			data: generateLargeDataset('ç²¾å“', 200),
			collapsed: false
		},
		{
			title: 'ä¸»é£Ÿç±»',
			data: generateLargeDataset('æ‹›ç‰Œ', 800),
			collapsed: false
		},
		{
			title: 'ç´ é£Ÿä¸“åŒº',
			data: generateLargeDataset('å¥åº·', 300),
			collapsed: false
		},
		{
			title: 'ç”œå“ç‚¹å¿ƒ',
			data: generateLargeDataset('ç”œèœœ', 500),
			collapsed: false
		},
		{
			title: 'é¥®å“æ¨è',
			data: generateLargeDataset('ç‰¹è°ƒ', 400),
			collapsed: false
		}
	];

	// è®¡ç®—æ€»é¡¹ç›®æ•°
	window.totalItems = datasets.reduce((sum, d) => sum + d.data.length, 0);

	// åˆå§‹åŒ–ç»Ÿä¸€è™šæ‹Ÿåˆ—è¡¨
	const listContainer = document.getElementById('listContainer');
	const virtualList = new UnifiedVirtualList(listContainer, {
		itemHeight: 60,
		headerHeight: 60
	});

	// è®¾ç½®æ•°æ®
	virtualList.setData(datasets);

	// å…¨å±€æ»šåŠ¨äº‹ä»¶ç›‘å¬ - ä½¿ç”¨èŠ‚æµ
	const throttledGlobalRender = throttle(() => {
		virtualList.updateOnScroll();
		updatePerformanceInfo();
	}, 32); // çº¦30fps

	window.addEventListener('scroll', throttledGlobalRender, { passive: true });

	// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
	window.addEventListener('resize', debounce(() => {
		virtualList.forceRefresh();
		updatePerformanceInfo();
	}, 300));

	// æ›´æ–°æ€§èƒ½ä¿¡æ¯
	function updatePerformanceInfo() {
		const allRendered = document.querySelectorAll('.virtual-list-item').length;
		const perfInfo = document.getElementById('performanceInfo');
		if (perfInfo) {
			perfInfo.textContent = `æ¸²æŸ“: ${allRendered} / ${window.totalItems} é¡¹ç›®`;
		}
	}

	// æ»šåŠ¨æç¤ºåŠŸèƒ½
	let scrollTimer;
	const scrollIndicator = document.getElementById('scrollIndicator');

	window.addEventListener('scroll', throttle(() => {
		scrollIndicator.classList.add('show');
		clearTimeout(scrollTimer);
		scrollTimer = setTimeout(() => {
			scrollIndicator.classList.remove('show');
		}, 1000);
	}, 100));

	// åˆå§‹æ¸²æŸ“
	setTimeout(() => {
		virtualList.updateOnScroll();
		updatePerformanceInfo();
	}, 100);
</script>
</body>
</html>
